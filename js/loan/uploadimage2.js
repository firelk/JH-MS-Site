function selectFileImage(t){var e=t.files[0],a=null,o=$(t).attr("id"),i=$(t).prev().attr("id");if($(t).val()&&0!=$(t).prev().css("opacity")&&($(t).prev().css("opacity","0"),e)){if(console.log("正在上传,请稍后..."),!/^(image\/jpeg|image\/png)$/i.test(e.type))return;if(EXIF.getData(e,function(){EXIF.getAllTags(this),a=EXIF.getTag(this,"Orientation")}),window.FileReader){var r=new FileReader;r.onload=function(t){var e=new Image;e.src=t.target.result,e.onload=function(){var t=this.naturalWidth,e=this.naturalHeight;this.naturalWidth>this.naturalHeight&&this.naturalWidth>1e3?e=(t=1e3)*this.naturalHeight/this.naturalWidth:this.naturalHeight>this.naturalWidth&&this.naturalHeight>1e3&&(t=(e=1e3)*this.naturalWidth/this.naturalHeight);var r=document.createElement("canvas"),n=r.getContext("2d");r.width=t,r.height=e,n.drawImage(this,0,0,t,e);if(navigator.userAgent.match(/iphone/i)){if(""!=a&&1!=a)switch(a){case 6:rotateImg(this,"left",r);break;case 8:rotateImg(this,"right",r);break;case 3:rotateImg(this,"",r)}postImgIphone(r.toDataURL("image/jpeg",.25),i,o)}else if(navigator.userAgent.match(/Android/i))postImgAndroid((new JPEGEncoder).encode(n.getImageData(0,0,t,e),90),i,o);else{if(""!=a&&1!=a)switch(a){case 6:rotateImg(this,"left",r);break;case 8:rotateImg(this,"right",r);break;case 3:rotateImg(this,"",r)}postImgAndroid(r.toDataURL("image/jpeg",.3),i,o)}}},r.readAsDataURL(e)}}}function photoTypeFn(t){var e="";return"Photo_A"==t&&(e="F"),"Photo_B"==t&&(e="R"),"Photo_C"==t&&(e="D"),e}function postImgAndroid(t,e,a){var o=$("#"+e),i=($("#"+a+"-src"),photoTypeFn(a));if(!t)return!1;$.ajax({url:"/msxfInterface/file/singleUpload.do",type:"post",dataType:"json",timeout:12e4,data:{openId:$.cookie("openId"),applyNo:$.cookie("applyNo"),photoBase64Code:t,photoType:i}}).done(function(){o.attr("src",t).css("opacity",1)}).fail(function(){console.log("error"),o.attr("src",o.data("src")).css("opacity",1)})}function postImgIphone(t,e,a){var o=$("#"+e),i=$("#"+a+"-src"),r=photoTypeFn(a),n=t,s=new FormData;try{c=new XMLHttpRequest}catch(t){console.log("开起 ie 兼容");var c=new ActiveXObject("Microsoft.XMLHTTP")}s.append("photoBase64Code",n),c.upload.addEventListener("progress",function(t){},!1),c.open("POST","/msxfInterface/file/singleUpload.do?openId="+encodeURIComponent($.cookie("openId"))+"&applyNo="+$.cookie("applyNo")+"&photoType="+r,!0),c.send(s),c.onreadystatechange=function(a){if(clearTimeout(window["setTimeFlag"+e]),4==c.readyState&&200==c.status){var r=c.responseText;console.log(r);var n=JSON.parse(r);console.log(n),0==n.code?(o.attr("src",t).css("opacity",1),i.val(n.src)):alert(n.message)}},window.uploadTimeoutFn=function(t){$.alert("上传失败，请重试!");var e=$("#"+t);e.attr("src",e.data("src")).css("opacity",1)},window["setTimeFlag"+e]=setTimeout('window.uploadTimeoutFn("'+e+'")',12e4)}function rotateImg(t,e,a){if(null!=t){var o=t.height,i=t.width,r=2;null==r&&(r=0),"right"==e?++r>3&&(r=0):"left"==e&&--r<0&&(r=3);var n=90*r*Math.PI/180,s=a.getContext("2d");switch(r){case 0:a.width=i,a.height=o,s.drawImage(t,0,0);break;case 1:a.width=o,a.height=i,s.rotate(n),s.drawImage(t,0,-o);break;case 2:a.width=i,a.height=o,s.rotate(n),s.drawImage(t,-i,-o);break;case 3:a.width=o,a.height=i,s.rotate(n),s.drawImage(t,-i,0)}}}